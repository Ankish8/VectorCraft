{% extends "admin/base.html" %}

{% block title %}Email Templates - VectorCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold tracking-tight">Email Templates</h1>
        <p class="text-muted-foreground">Create and manage your email templates</p>
    </div>
    <div class="flex space-x-2">
        <button onclick="refreshTemplates()" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors">
            <i data-lucide="refresh-cw" class="mr-2 h-4 w-4"></i>
            Refresh
        </button>
        <a href="{{ url_for('admin_email_templates_new') }}" class="inline-flex items-center px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors">
            <i data-lucide="plus" class="mr-2 h-4 w-4"></i>
            New Template
        </a>
    </div>
</div>

<!-- Template Categories Filter -->
<div class="mb-6">
    <div class="flex flex-wrap gap-2">
        <button onclick="filterTemplates('all')" class="category-filter active px-3 py-1 text-sm rounded-full border border-border bg-background hover:bg-accent transition-colors" data-category="all">
            All Templates
        </button>
        <button onclick="filterTemplates('welcome')" class="category-filter px-3 py-1 text-sm rounded-full border border-border bg-background hover:bg-accent transition-colors" data-category="welcome">
            Welcome
        </button>
        <button onclick="filterTemplates('purchase')" class="category-filter px-3 py-1 text-sm rounded-full border border-border bg-background hover:bg-accent transition-colors" data-category="purchase">
            Purchase
        </button>
        <button onclick="filterTemplates('followup')" class="category-filter px-3 py-1 text-sm rounded-full border border-border bg-background hover:bg-accent transition-colors" data-category="followup">
            Follow-up
        </button>
        <button onclick="filterTemplates('promotional')" class="category-filter px-3 py-1 text-sm rounded-full border border-border bg-background hover:bg-accent transition-colors" data-category="promotional">
            Promotional
        </button>
    </div>
</div>

<!-- Templates Grid -->
<div id="templatesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div class="col-span-full flex flex-col items-center justify-center py-12">
        <div class="animate-spin mb-4">
            <i data-lucide="loader" class="h-8 w-8 text-muted-foreground"></i>
        </div>
        <p class="text-muted-foreground">Loading templates...</p>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="hidden text-center py-12">
    <div class="flex justify-center mb-4">
        <div class="p-3 bg-muted rounded-full">
            <i data-lucide="file-text" class="h-8 w-8 text-muted-foreground"></i>
        </div>
    </div>
    <h3 class="text-lg font-semibold mb-2">No email templates yet</h3>
    <p class="text-muted-foreground mb-6">Get started by creating your first email template</p>
    <a href="{{ url_for('admin_email_templates_new') }}" class="inline-flex items-center px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors">
        <i data-lucide="plus" class="mr-2 h-4 w-4"></i>
        Create First Template
    </a>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4">Delete Template</h3>
            <p class="text-muted-foreground mb-6">Are you sure you want to delete this template? This action cannot be undone.</p>
            <div class="flex justify-end space-x-2">
                <button onclick="closeDeleteModal()" class="px-4 py-2 text-sm border border-border rounded-md hover:bg-accent transition-colors">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="px-4 py-2 text-sm bg-destructive text-destructive-foreground rounded-md hover:bg-destructive/90 transition-colors">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let templates = [];
    let currentFilter = 'all';
    let templateToDelete = null;
    
    function refreshTemplates() {
        loadTemplates();
    }
    
    function loadTemplates() {
        fetch('/admin/api/email/templates')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    templates = data.templates;
                    displayTemplates();
                } else {
                    console.error('Failed to load templates:', data.error);
                    document.getElementById('templatesContainer').innerHTML = 
                        '<div class="col-span-full p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading templates: ' + data.error + '</div>';
                }
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                document.getElementById('templatesContainer').innerHTML = 
                    '<div class="col-span-full p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading templates</div>';
            });
    }
    
    function displayTemplates() {
        const container = document.getElementById('templatesContainer');
        const emptyState = document.getElementById('emptyState');
        
        let filteredTemplates = templates;
        if (currentFilter !== 'all') {
            filteredTemplates = templates.filter(template => template.category === currentFilter);
        }
        
        if (filteredTemplates.length === 0) {
            container.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }
        
        container.classList.remove('hidden');
        emptyState.classList.add('hidden');
        
        container.innerHTML = filteredTemplates.map(template => `
            <div class="bg-card rounded-lg border border-border overflow-hidden hover:shadow-md transition-shadow">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs px-2 py-1 rounded-full bg-secondary text-secondary-foreground">${template.category}</span>
                        <div class="flex items-center space-x-1">
                            <button onclick="editTemplate(${template.id})" class="p-1 hover:bg-accent rounded" title="Edit">
                                <i data-lucide="edit" class="h-4 w-4"></i>
                            </button>
                            <button onclick="showDeleteModal(${template.id}, '${template.name}')" class="p-1 hover:bg-accent rounded text-destructive" title="Delete">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="font-semibold mb-2">${template.name}</h3>
                    <p class="text-sm text-muted-foreground mb-3">${template.subject}</p>
                    ${template.description ? `<p class="text-xs text-muted-foreground mb-3">${template.description}</p>` : ''}
                    <div class="flex items-center justify-between text-xs text-muted-foreground">
                        <span>Created: ${new Date(template.created_at).toLocaleDateString()}</span>
                        <span class="${template.is_active ? 'text-green-600' : 'text-red-600'}">${template.is_active ? 'Active' : 'Inactive'}</span>
                    </div>
                </div>
                <div class="border-t border-border p-3 bg-muted/50">
                    <div class="flex justify-between">
                        <button onclick="previewTemplate(${template.id})" class="text-xs text-primary hover:underline">
                            Preview
                        </button>
                        <button onclick="sendTestEmail(${template.id})" class="text-xs text-primary hover:underline">
                            Send Test
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        lucide.createIcons();
    }
    
    function filterTemplates(category) {
        currentFilter = category;
        
        // Update filter buttons
        document.querySelectorAll('.category-filter').forEach(btn => {
            btn.classList.remove('active', 'bg-primary', 'text-primary-foreground');
            btn.classList.add('bg-background');
        });
        
        const activeBtn = document.querySelector(`[data-category="${category}"]`);
        activeBtn.classList.add('active', 'bg-primary', 'text-primary-foreground');
        activeBtn.classList.remove('bg-background');
        
        displayTemplates();
    }
    
    function editTemplate(templateId) {
        window.location.href = `/admin/email/templates/${templateId}/edit`;
    }
    
    function previewTemplate(templateId) {
        // TODO: Implement template preview modal
        alert('Template preview coming soon!');
    }
    
    function sendTestEmail(templateId) {
        const email = prompt('Enter email address for test:');
        if (email) {
            fetch('/admin/api/email/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    template_id: templateId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Test email queued successfully!');
                } else {
                    alert('Error sending test email: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error sending test email:', error);
                alert('Error sending test email');
            });
        }
    }
    
    function showDeleteModal(templateId, templateName) {
        templateToDelete = templateId;
        document.getElementById('deleteModal').classList.remove('hidden');
    }
    
    function closeDeleteModal() {
        templateToDelete = null;
        document.getElementById('deleteModal').classList.add('hidden');
    }
    
    function confirmDelete() {
        if (templateToDelete) {
            fetch(`/admin/api/email/templates/${templateToDelete}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeDeleteModal();
                    loadTemplates();
                } else {
                    alert('Error deleting template: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting template:', error);
                alert('Error deleting template');
            });
        }
    }
    
    // Load templates on page load
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        loadTemplates();
    });
    
    // Make functions available globally
    window.refreshTemplates = refreshTemplates;
    window.filterTemplates = filterTemplates;
    window.editTemplate = editTemplate;
    window.previewTemplate = previewTemplate;
    window.sendTestEmail = sendTestEmail;
    window.showDeleteModal = showDeleteModal;
    window.closeDeleteModal = closeDeleteModal;
    window.confirmDelete = confirmDelete;
</script>
{% endblock %}