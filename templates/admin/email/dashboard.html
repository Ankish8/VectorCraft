{% extends "admin/base.html" %}

{% block title %}Email Marketing Dashboard - VectorCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold tracking-tight">Email Marketing Dashboard</h1>
        <p class="text-muted-foreground">Manage your email automation and campaigns</p>
    </div>
    <button onclick="refreshData()" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors">
        <i data-lucide="refresh-cw" class="mr-2 h-4 w-4"></i>
        Refresh
    </button>
</div>

<!-- Email Marketing Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-blue-100 rounded-full">
                <i data-lucide="mail" class="h-8 w-8 text-blue-600"></i>
            </div>
        </div>
        <h3 class="text-2xl font-bold text-blue-600 mb-2" id="totalEmails">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Total Emails Sent</p>
    </div>
    
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-green-100 rounded-full">
                <i data-lucide="mail-open" class="h-8 w-8 text-green-600"></i>
            </div>
        </div>
        <h3 class="text-2xl font-bold text-green-600 mb-2" id="openRate">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Open Rate</p>
    </div>
    
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-purple-100 rounded-full">
                <i data-lucide="mouse-pointer-click" class="h-8 w-8 text-purple-600"></i>
            </div>
        </div>
        <h3 class="text-2xl font-bold text-purple-600 mb-2" id="clickRate">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Click Rate</p>
    </div>
    
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-orange-100 rounded-full">
                <i data-lucide="zap" class="h-8 w-8 text-orange-600"></i>
            </div>
        </div>
        <h3 class="text-2xl font-bold text-orange-600 mb-2" id="activeAutomations">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Active Automations</p>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center px-6 py-4 border-b border-border">
            <i data-lucide="zap" class="mr-2 h-5 w-5 text-muted-foreground"></i>
            <h3 class="text-lg font-semibold">Quick Actions</h3>
        </div>
        <div class="p-6 space-y-4">
            <a href="{{ url_for('admin_email_templates_new') }}" class="inline-flex items-center px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors">
                <i data-lucide="plus" class="mr-2 h-4 w-4"></i>
                Create Email Template
            </a>
            <a href="{{ url_for('admin_email_automations') }}" class="inline-flex items-center px-4 py-2 bg-secondary text-secondary-foreground rounded-md hover:bg-secondary/90 transition-colors ml-4">
                <i data-lucide="zap" class="mr-2 h-4 w-4"></i>
                Setup Automation
            </a>
        </div>
    </div>
    
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center px-6 py-4 border-b border-border">
            <i data-lucide="clock" class="mr-2 h-5 w-5 text-muted-foreground"></i>
            <h3 class="text-lg font-semibold">Recent Activity</h3>
        </div>
        <div class="p-6">
            <div id="recentActivity" class="space-y-3">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <i data-lucide="loader" class="h-6 w-6 text-muted-foreground"></i>
                    </div>
                    <span class="ml-2 text-muted-foreground">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Templates and Automations Overview -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center justify-between px-6 py-4 border-b border-border">
            <div class="flex items-center">
                <i data-lucide="file-text" class="mr-2 h-5 w-5 text-muted-foreground"></i>
                <h3 class="text-lg font-semibold">Email Templates</h3>
            </div>
            <a href="{{ url_for('admin_email_templates') }}" class="text-sm text-primary hover:underline">View All</a>
        </div>
        <div class="p-6">
            <div id="emailTemplates" class="space-y-3">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <i data-lucide="loader" class="h-6 w-6 text-muted-foreground"></i>
                    </div>
                    <span class="ml-2 text-muted-foreground">Loading templates...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center justify-between px-6 py-4 border-b border-border">
            <div class="flex items-center">
                <i data-lucide="zap" class="mr-2 h-5 w-5 text-muted-foreground"></i>
                <h3 class="text-lg font-semibold">Email Automations</h3>
            </div>
            <a href="{{ url_for('admin_email_automations') }}" class="text-sm text-primary hover:underline">View All</a>
        </div>
        <div class="p-6">
            <div id="emailAutomations" class="space-y-3">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <i data-lucide="loader" class="h-6 w-6 text-muted-foreground"></i>
                    </div>
                    <span class="ml-2 text-muted-foreground">Loading automations...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function refreshData() {
        loadEmailAnalytics();
        loadEmailTemplates();
        loadEmailAutomations();
    }
    
    function loadEmailAnalytics() {
        fetch('/admin/api/email/analytics')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.analytics) {
                    const analytics = data.analytics;
                    document.getElementById('totalEmails').textContent = analytics.total_sent || 0;
                    document.getElementById('openRate').textContent = (analytics.open_rate || 0).toFixed(1) + '%';
                    document.getElementById('clickRate').textContent = (analytics.click_rate || 0).toFixed(1) + '%';
                } else {
                    console.error('Failed to load email analytics:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading email analytics:', error);
            });
    }
    
    function loadEmailTemplates() {
        fetch('/admin/api/email/templates?limit=5')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('emailTemplates');
                    if (data.templates.length === 0) {
                        container.innerHTML = '<p class="text-muted-foreground text-center py-4">No templates created yet</p>';
                    } else {
                        container.innerHTML = data.templates.map(template => `
                            <div class="flex items-center justify-between p-3 border border-border rounded-md">
                                <div>
                                    <h4 class="font-medium">${template.name}</h4>
                                    <p class="text-sm text-muted-foreground">${template.category}</p>
                                </div>
                                <a href="/admin/email/templates/${template.id}/edit" class="text-primary hover:underline text-sm">Edit</a>
                            </div>
                        `).join('');
                    }
                } else {
                    document.getElementById('emailTemplates').innerHTML = '<p class="text-destructive text-center py-4">Error loading templates</p>';
                }
            })
            .catch(error => {
                console.error('Error loading email templates:', error);
                document.getElementById('emailTemplates').innerHTML = '<p class="text-destructive text-center py-4">Error loading templates</p>';
            });
    }
    
    function loadEmailAutomations() {
        fetch('/admin/api/email/automations')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('emailAutomations');
                    document.getElementById('activeAutomations').textContent = data.automations.length;
                    
                    if (data.automations.length === 0) {
                        container.innerHTML = '<p class="text-muted-foreground text-center py-4">No automations created yet</p>';
                    } else {
                        container.innerHTML = data.automations.slice(0, 5).map(automation => `
                            <div class="flex items-center justify-between p-3 border border-border rounded-md">
                                <div>
                                    <h4 class="font-medium">${automation.name}</h4>
                                    <p class="text-sm text-muted-foreground">${automation.trigger_type}</p>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${automation.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${automation.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        `).join('');
                    }
                } else {
                    document.getElementById('emailAutomations').innerHTML = '<p class="text-destructive text-center py-4">Error loading automations</p>';
                }
            })
            .catch(error => {
                console.error('Error loading email automations:', error);
                document.getElementById('emailAutomations').innerHTML = '<p class="text-destructive text-center py-4">Error loading automations</p>';
            });
    }
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        refreshData();
    });
    
    // Make refreshData available globally
    window.refreshData = refreshData;
</script>
{% endblock %}