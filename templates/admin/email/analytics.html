{% extends "admin/base.html" %}

{% block title %}Email Analytics - VectorCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold tracking-tight">Email Analytics</h1>
        <p class="text-muted-foreground">Track performance and insights</p>
    </div>
    <div class="flex space-x-2">
        <select id="timeRange" class="px-3 py-2 text-sm border border-border rounded-md bg-background">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
        </select>
        <button onclick="refreshData()" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors">
            <i data-lucide="refresh-cw" class="mr-2 h-4 w-4"></i>
            Refresh
        </button>
    </div>
</div>

<!-- Key Metrics Overview -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-blue-100 rounded-full">
                <i data-lucide="mail" class="h-8 w-8 text-blue-600"></i>
            </div>
        </div>
        <h3 class="text-3xl font-bold text-blue-600 mb-2" id="totalSent">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Emails Sent</p>
        <p class="text-xs text-muted-foreground mt-1" id="sentChange">-</p>
    </div>
    
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-green-100 rounded-full">
                <i data-lucide="mail-open" class="h-8 w-8 text-green-600"></i>
            </div>
        </div>
        <h3 class="text-3xl font-bold text-green-600 mb-2" id="openRate">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Open Rate</p>
        <p class="text-xs text-muted-foreground mt-1" id="openChange">-</p>
    </div>
    
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-purple-100 rounded-full">
                <i data-lucide="mouse-pointer-click" class="h-8 w-8 text-purple-600"></i>
            </div>
        </div>
        <h3 class="text-3xl font-bold text-purple-600 mb-2" id="clickRate">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Click Rate</p>
        <p class="text-xs text-muted-foreground mt-1" id="clickChange">-</p>
    </div>
    
    <div class="bg-card rounded-lg border border-border p-6 text-center">
        <div class="flex justify-center mb-4">
            <div class="p-3 bg-red-100 rounded-full">
                <i data-lucide="user-x" class="h-8 w-8 text-red-600"></i>
            </div>
        </div>
        <h3 class="text-3xl font-bold text-red-600 mb-2" id="unsubscribeRate">-</h3>
        <p class="text-sm font-medium text-muted-foreground">Unsubscribe Rate</p>
        <p class="text-xs text-muted-foreground mt-1" id="unsubChange">-</p>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center justify-between px-6 py-4 border-b border-border">
            <h3 class="text-lg font-semibold">Email Performance Over Time</h3>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                <span class="text-sm text-muted-foreground">Sent</span>
                <span class="w-3 h-3 bg-green-500 rounded-full ml-4"></span>
                <span class="text-sm text-muted-foreground">Opens</span>
                <span class="w-3 h-3 bg-purple-500 rounded-full ml-4"></span>
                <span class="text-sm text-muted-foreground">Clicks</span>
            </div>
        </div>
        <div class="p-6">
            <canvas id="performanceChart" width="400" height="300"></canvas>
        </div>
    </div>
    
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center px-6 py-4 border-b border-border">
            <h3 class="text-lg font-semibold">Template Performance</h3>
        </div>
        <div class="p-6">
            <canvas id="templateChart" width="400" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Detailed Analytics -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center justify-between px-6 py-4 border-b border-border">
            <h3 class="text-lg font-semibold">Top Performing Templates</h3>
            <a href="{{ url_for('admin_email_templates') }}" class="text-sm text-primary hover:underline">View All</a>
        </div>
        <div class="p-6">
            <div id="topTemplates" class="space-y-4">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <i data-lucide="loader" class="h-6 w-6 text-muted-foreground"></i>
                    </div>
                    <span class="ml-2 text-muted-foreground">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-card rounded-lg border border-border">
        <div class="flex items-center justify-between px-6 py-4 border-b border-border">
            <h3 class="text-lg font-semibold">Recent Email Activity</h3>
            <a href="{{ url_for('admin_email_campaigns') }}" class="text-sm text-primary hover:underline">View All</a>
        </div>
        <div class="p-6">
            <div id="recentActivity" class="space-y-4">
                <div class="flex items-center justify-center py-8">
                    <div class="animate-spin">
                        <i data-lucide="loader" class="h-6 w-6 text-muted-foreground"></i>
                    </div>
                    <span class="ml-2 text-muted-foreground">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Engagement Heatmap -->
<div class="mt-8 bg-card rounded-lg border border-border">
    <div class="flex items-center px-6 py-4 border-b border-border">
        <h3 class="text-lg font-semibold">Engagement Heatmap</h3>
        <p class="text-sm text-muted-foreground ml-4">Best times to send emails</p>
    </div>
    <div class="p-6">
        <div id="heatmapContainer" class="overflow-x-auto">
            <div class="min-w-full">
                <div class="text-center text-muted-foreground">
                    <i data-lucide="calendar" class="h-16 w-16 mx-auto mb-4 opacity-50"></i>
                    <p>Engagement heatmap coming soon</p>
                    <p class="text-sm">Track optimal send times based on user engagement</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let performanceChart, templateChart;
    
    function refreshData() {
        loadAnalytics();
        loadTopTemplates();
        loadRecentActivity();
    }
    
    function loadAnalytics() {
        const days = document.getElementById('timeRange').value;
        
        fetch(`/admin/api/email/analytics?days=${days}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.analytics) {
                    const analytics = data.analytics;
                    updateMetrics(analytics);
                    updateCharts(analytics);
                } else {
                    console.error('Failed to load analytics:', data.error);
                    // Show zero data instead of mock data
                    showZeroData();
                }
            })
            .catch(error => {
                console.error('Error loading analytics:', error);
                // Show zero data instead of mock data
                showZeroData();
            });
    }
    
    function showZeroData() {
        const zeroAnalytics = {
            total_sent: 0,
            total_opened: 0,
            total_clicked: 0,
            total_failed: 0,
            open_rate: 0.0,
            click_rate: 0.0,
            failure_rate: 0.0
        };
        updateMetrics(zeroAnalytics);
        updateCharts(zeroAnalytics);
    }
    
    function updateMetrics(analytics) {
        document.getElementById('totalSent').textContent = analytics.total_sent || 0;
        document.getElementById('openRate').textContent = (analytics.open_rate || 0).toFixed(1) + '%';
        document.getElementById('clickRate').textContent = (analytics.click_rate || 0).toFixed(1) + '%';
        document.getElementById('unsubscribeRate').textContent = (analytics.failure_rate || 0).toFixed(1) + '%';
        
        // Update change indicators - for now show "No change" since we don't have historical comparison
        document.getElementById('sentChange').textContent = 'No change';
        document.getElementById('openChange').textContent = 'No change';
        document.getElementById('clickChange').textContent = 'No change';
        document.getElementById('unsubChange').textContent = 'No change';
    }
    
    function updateCharts(analytics) {
        // Performance Chart
        const ctx1 = document.getElementById('performanceChart').getContext('2d');
        if (performanceChart) {
            performanceChart.destroy();
        }
        
        const last7Days = [];
        const sentData = [];
        const openData = [];
        const clickData = [];
        
        // Generate real chart data (for now showing zeros until we have time-series data)
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
            sentData.push(0); // Real data would come from daily analytics
            openData.push(0);
            clickData.push(0);
        }
        
        performanceChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Sent',
                    data: sentData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Opens',
                    data: openData,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Clicks',
                    data: clickData,
                    borderColor: 'rgb(168, 85, 247)',
                    backgroundColor: 'rgba(168, 85, 247, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Template Performance Chart
        const ctx2 = document.getElementById('templateChart').getContext('2d');
        if (templateChart) {
            templateChart.destroy();
        }
        
        templateChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['No data yet'],
                datasets: [{
                    data: [100],
                    backgroundColor: [
                        'rgb(156, 163, 175)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function loadTopTemplates() {
        const days = document.getElementById('timeRange').value;
        
        fetch(`/admin/api/email/templates/top?days=${days}&limit=4`)
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('topTemplates');
                
                if (data.success && data.templates && data.templates.length > 0) {
                    container.innerHTML = data.templates.map((template, index) => `
                        <div class="flex items-center justify-between p-3 bg-muted/30 rounded-md">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-sm font-bold">
                                    ${index + 1}
                                </div>
                                <div>
                                    <h4 class="font-medium">${template.name}</h4>
                                    <p class="text-sm text-muted-foreground">${template.sent_count} sent</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium">${template.open_rate.toFixed(1)}% open</div>
                                <div class="text-sm text-muted-foreground">${template.click_rate.toFixed(1)}% click</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-muted-foreground">
                            <i data-lucide="mail" class="h-8 w-8 mx-auto mb-2 opacity-50"></i>
                            <p>No template data available</p>
                            <p class="text-sm">Send some emails to see performance metrics</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            })
            .catch(error => {
                console.error('Error loading top templates:', error);
                const container = document.getElementById('topTemplates');
                container.innerHTML = `
                    <div class="text-center py-8 text-muted-foreground">
                        <p>Error loading template data</p>
                    </div>
                `;
            });
    }
    
    function loadRecentActivity() {
        fetch('/admin/api/email/activity/recent?limit=5')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('recentActivity');
                
                if (data.success && data.activities && data.activities.length > 0) {
                    container.innerHTML = data.activities.map(activity => `
                        <div class="flex items-center space-x-3 p-3 border border-border rounded-md">
                            <div class="w-2 h-2 rounded-full ${getActivityColor(activity.type)}"></div>
                            <div class="flex-1">
                                <p class="text-sm">${activity.message}</p>
                                <p class="text-xs text-muted-foreground">${activity.time_ago}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-muted-foreground">
                            <i data-lucide="activity" class="h-8 w-8 mx-auto mb-2 opacity-50"></i>
                            <p>No recent activity</p>
                            <p class="text-sm">Email activity will appear here</p>
                        </div>
                    `;
                    lucide.createIcons();
                }
            })
            .catch(error => {
                console.error('Error loading recent activity:', error);
                const container = document.getElementById('recentActivity');
                container.innerHTML = `
                    <div class="text-center py-8 text-muted-foreground">
                        <p>Error loading activity data</p>
                    </div>
                `;
            });
    }
    
    function getActivityColor(type) {
        switch(type) {
            case 'email_sent': return 'bg-blue-500';
            case 'email_opened': return 'bg-green-500';
            case 'email_clicked': return 'bg-purple-500';
            case 'automation_triggered': return 'bg-orange-500';
            case 'email_bounced': return 'bg-red-500';
            default: return 'bg-gray-500';
        }
    }
    
    // Time range change handler
    document.getElementById('timeRange').addEventListener('change', function() {
        refreshData();
    });
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        refreshData();
    });
    
    // Make refreshData available globally
    window.refreshData = refreshData;
</script>
{% endblock %}