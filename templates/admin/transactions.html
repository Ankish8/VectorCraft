{% extends "admin/base.html" %}

{% block title %}Transactions - VectorCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold tracking-tight">Transaction Monitoring</h1>
        <p class="text-muted-foreground">View and manage all payment transactions</p>
    </div>
    <button onclick="refreshData()" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors">
        <i data-lucide="refresh-cw" class="mr-2 h-4 w-4"></i>
        Refresh
    </button>
</div>

<!-- Filters -->
<div class="bg-card rounded-lg border border-border mb-6">
    <div class="flex items-center px-6 py-4 border-b border-border">
        <i data-lucide="filter" class="mr-2 h-5 w-5 text-muted-foreground"></i>
        <h3 class="text-lg font-semibold">Filters</h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Status</label>
                <select id="statusFilter" class="w-full px-3 py-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">All Statuses</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Email</label>
                <input type="email" id="emailFilter" placeholder="Search by email" class="w-full px-3 py-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Limit</label>
                <select id="limitFilter" class="w-full px-3 py-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="50">50 transactions</option>
                    <option value="100">100 transactions</option>
                    <option value="200">200 transactions</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="applyFilters()" class="w-full inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors">
                    <i data-lucide="search" class="mr-2 h-4 w-4"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="bg-card rounded-lg border border-border">
    <div class="flex items-center justify-between px-6 py-4 border-b border-border">
        <div class="flex items-center space-x-2">
            <i data-lucide="table" class="h-5 w-5 text-muted-foreground"></i>
            <h3 class="text-lg font-semibold">Recent Transactions</h3>
        </div>
        <span id="transactionCount" class="px-2 py-1 bg-primary text-primary-foreground rounded-full text-xs font-medium">Loading...</span>
    </div>
    <div class="p-6">
        <div id="transactionsTable">
            <div class="flex flex-col items-center justify-center py-12">
                <div class="animate-spin mb-4">
                    <i data-lucide="loader" class="h-8 w-8 text-muted-foreground"></i>
                </div>
                <p class="text-muted-foreground">Loading transactions...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function refreshData() {
        loadTransactions();
    }
    
    function applyFilters() {
        loadTransactions();
    }
    
    function loadTransactions() {
        const status = document.getElementById('statusFilter').value;
        const email = document.getElementById('emailFilter').value;
        const limit = document.getElementById('limitFilter').value;
        
        let url = '/admin/api/transactions?';
        const params = new URLSearchParams();
        
        if (status) params.append('status', status);
        if (email) params.append('email', email);
        if (limit) params.append('limit', limit);
        
        url += params.toString();
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTransactions(data.transactions);
                    document.getElementById('transactionCount').textContent = data.count;
                } else {
                    document.getElementById('transactionsTable').innerHTML = 
                        '<div class="p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading transactions: ' + data.error + '</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('transactionsTable').innerHTML = 
                    '<div class="p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading transactions</div>';
            });
    }
    
    function displayTransactions(transactions) {
        if (transactions.length === 0) {
            document.getElementById('transactionsTable').innerHTML = 
                '<div class="flex flex-col items-center justify-center py-12"><i data-lucide="inbox" class="h-16 w-16 text-muted-foreground mb-4"></i><p class="text-muted-foreground">No transactions found</p></div>';
            lucide.createIcons();
            return;
        }
        
        let html = `
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">Transaction ID</th>
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">Email</th>
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">Username</th>
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">Amount</th>
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">Status</th>
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">PayPal Order</th>
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">Created</th>
                            <th class="text-left py-3 px-4 font-medium text-sm text-muted-foreground">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        transactions.forEach(tx => {
            let statusClass, statusBg;
            switch(tx.status) {
                case 'completed':
                    statusClass = 'text-green-800';
                    statusBg = 'bg-green-100';
                    break;
                case 'pending':
                    statusClass = 'text-yellow-800';
                    statusBg = 'bg-yellow-100';
                    break;
                case 'failed':
                    statusClass = 'text-red-800';
                    statusBg = 'bg-red-100';
                    break;
                default:
                    statusClass = 'text-gray-800';
                    statusBg = 'bg-gray-100';
            }
            
            html += `
                <tr class="border-b border-border hover:bg-muted/50 transition-colors">
                    <td class="py-3 px-4">
                        <code class="text-xs bg-muted px-2 py-1 rounded">${tx.transaction_id}</code>
                    </td>
                    <td class="py-3 px-4 text-sm">${tx.email}</td>
                    <td class="py-3 px-4 text-sm text-muted-foreground">${tx.username || '-'}</td>
                    <td class="py-3 px-4 text-sm font-medium">$${parseFloat(tx.amount || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusBg} ${statusClass}">
                            ${tx.status}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-xs text-muted-foreground">${tx.paypal_order_id || '-'}</td>
                    <td class="py-3 px-4 text-xs text-muted-foreground">${tx.created_at}</td>
                    <td class="py-3 px-4">
                        <button onclick="viewTransaction('${tx.transaction_id}')" class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors">
                            <i data-lucide="eye" class="h-3 w-3"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        document.getElementById('transactionsTable').innerHTML = html;
        lucide.createIcons();
    }
    
    function viewTransaction(transactionId) {
        alert('Transaction details for: ' + transactionId);
        // In a real implementation, this would open a modal with detailed transaction info
    }
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        loadTransactions();
    });
    
    // Make refreshData available globally
    window.refreshData = refreshData;
</script>
{% endblock %}