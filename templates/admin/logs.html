{% extends "admin/base.html" %}

{% block title %}System Logs - VectorCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold tracking-tight">System Logs</h1>
        <p class="text-muted-foreground">Monitor system events and troubleshoot issues</p>
    </div>
    <button onclick="refreshData()" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors">
        <i data-lucide="refresh-cw" class="mr-2 h-4 w-4"></i>
        Refresh
    </button>
</div>

<!-- Filters -->
<div class="bg-card rounded-lg border border-border mb-6">
    <div class="flex items-center px-6 py-4 border-b border-border">
        <i data-lucide="filter" class="mr-2 h-5 w-5 text-muted-foreground"></i>
        <h3 class="text-lg font-semibold">Log Filters</h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Level</label>
                <select id="levelFilter" class="w-full px-3 py-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">All Levels</option>
                    <option value="CRITICAL">Critical</option>
                    <option value="ERROR">Error</option>
                    <option value="WARNING">Warning</option>
                    <option value="INFO">Info</option>
                    <option value="DEBUG">Debug</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Component</label>
                <select id="componentFilter" class="w-full px-3 py-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">All Components</option>
                    <option value="auth">Authentication</option>
                    <option value="payment">Payment</option>
                    <option value="email">Email</option>
                    <option value="vectorization">Vectorization</option>
                    <option value="admin">Admin</option>
                    <option value="database">Database</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Time Period</label>
                <select id="hoursFilter" class="w-full px-3 py-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="1">Last Hour</option>
                    <option value="6">Last 6 Hours</option>
                    <option value="24" selected>Last 24 Hours</option>
                    <option value="72">Last 3 Days</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="applyFilters()" class="w-full inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors">
                    <i data-lucide="search" class="mr-2 h-4 w-4"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Logs -->
<div class="bg-card rounded-lg border border-border">
    <div class="flex items-center justify-between px-6 py-4 border-b border-border">
        <div class="flex items-center space-x-2">
            <i data-lucide="file-text" class="h-5 w-5 text-muted-foreground"></i>
            <h3 class="text-lg font-semibold">Log Entries</h3>
        </div>
        <span id="logCount" class="px-2 py-1 bg-primary text-primary-foreground rounded-full text-xs font-medium">Loading...</span>
    </div>
    <div class="p-6">
        <div id="logsContainer">
            <div class="flex flex-col items-center justify-center py-12">
                <div class="animate-spin mb-4">
                    <i data-lucide="loader" class="h-8 w-8 text-muted-foreground"></i>
                </div>
                <p class="text-muted-foreground">Loading logs...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function refreshData() {
        loadLogs();
    }
    
    function applyFilters() {
        loadLogs();
    }
    
    function loadLogs() {
        const level = document.getElementById('levelFilter').value;
        const component = document.getElementById('componentFilter').value;
        const hours = document.getElementById('hoursFilter').value;
        
        let url = '/admin/api/logs?';
        const params = new URLSearchParams();
        
        if (level) params.append('level', level);
        if (component) params.append('component', component);
        if (hours) params.append('hours', hours);
        params.append('limit', '100');
        
        url += params.toString();
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLogs(data.logs);
                    document.getElementById('logCount').textContent = data.count;
                } else {
                    document.getElementById('logsContainer').innerHTML = 
                        '<div class="p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading logs: ' + data.error + '</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('logsContainer').innerHTML = 
                    '<div class="p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading logs</div>';
            });
    }
    
    function displayLogs(logs) {
        if (logs.length === 0) {
            document.getElementById('logsContainer').innerHTML = 
                '<div class="flex flex-col items-center justify-center py-12"><i data-lucide="inbox" class="h-16 w-16 text-muted-foreground mb-4"></i><p class="text-muted-foreground">No logs found</p></div>';
            lucide.createIcons();
            return;
        }
        
        let html = '<div class="space-y-3">';
        
        logs.forEach(log => {
            let levelClass, levelBg, iconName;
            
            switch(log.level) {
                case 'CRITICAL':
                case 'ERROR':
                    levelClass = 'text-red-800';
                    levelBg = 'bg-red-100';
                    iconName = 'alert-circle';
                    break;
                case 'WARNING':
                    levelClass = 'text-yellow-800';
                    levelBg = 'bg-yellow-100';
                    iconName = 'alert-triangle';
                    break;
                case 'INFO':
                    levelClass = 'text-blue-800';
                    levelBg = 'bg-blue-100';
                    iconName = 'info';
                    break;
                case 'DEBUG':
                    levelClass = 'text-gray-800';
                    levelBg = 'bg-gray-100';
                    iconName = 'bug';
                    break;
                default:
                    levelClass = 'text-gray-800';
                    levelBg = 'bg-gray-100';
                    iconName = 'circle';
            }
            
            html += `
                <div class="p-4 border border-border rounded-lg bg-card hover:bg-muted/50 transition-colors">
                    <div class="flex items-start space-x-3">
                        <div class="p-2 ${levelBg} rounded-full">
                            <i data-lucide="${iconName}" class="h-4 w-4 ${levelClass}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${levelBg} ${levelClass}">
                                    ${log.level}
                                </span>
                                <span class="font-medium text-sm">${log.component}</span>
                                <span class="text-xs text-muted-foreground">${log.created_at}</span>
                            </div>
                            <p class="text-sm text-card-foreground mb-2">${log.message}</p>
                            <div class="flex flex-wrap items-center gap-4 text-xs text-muted-foreground">
                                ${log.user_email ? `<span>User: ${log.user_email}</span>` : ''}
                                ${log.transaction_id ? `<span>TX: ${log.transaction_id}</span>` : ''}
                            </div>
                            ${log.details ? `
                                <details class="mt-3">
                                    <summary class="text-xs text-muted-foreground cursor-pointer hover:text-foreground">Show details</summary>
                                    <pre class="text-xs mt-2 p-3 bg-muted rounded-md overflow-auto">${JSON.stringify(JSON.parse(log.details), null, 2)}</pre>
                                </details>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('logsContainer').innerHTML = html;
        lucide.createIcons();
    }
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        loadLogs();
    });
    
    // Make refreshData available globally
    window.refreshData = refreshData;
</script>
{% endblock %}