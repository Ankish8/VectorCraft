{% extends "admin/base.html" %}

{% block title %}Alerts - VectorCraft Admin{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold tracking-tight">Alert Management</h1>
        <p class="text-muted-foreground">Monitor and manage system alerts and notifications</p>
    </div>
    <button onclick="refreshData()" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors">
        <i data-lucide="refresh-cw" class="mr-2 h-4 w-4"></i>
        Refresh
    </button>
</div>

<!-- Alert Summary -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="alertSummary">
    <div class="col-span-full flex flex-col items-center justify-center py-12">
        <div class="animate-spin mb-4">
            <i data-lucide="loader" class="h-8 w-8 text-muted-foreground"></i>
        </div>
        <p class="text-muted-foreground">Loading alert summary...</p>
    </div>
</div>

<!-- Alert Filters -->
<div class="bg-card rounded-lg border border-border mb-6">
    <div class="flex items-center px-6 py-4 border-b border-border">
        <i data-lucide="filter" class="mr-2 h-5 w-5 text-muted-foreground"></i>
        <h3 class="text-lg font-semibold">Alert Filters</h3>
    </div>
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium mb-2">Status</label>
                <select id="resolvedFilter" class="w-full px-3 py-2 border border-border rounded-md bg-background focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="">All Alerts</option>
                    <option value="false" selected>Active Only</option>
                    <option value="true">Resolved Only</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="applyFilters()" class="w-full inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors">
                    <i data-lucide="search" class="mr-2 h-4 w-4"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alerts -->
<div class="bg-card rounded-lg border border-border">
    <div class="flex items-center justify-between px-6 py-4 border-b border-border">
        <div class="flex items-center space-x-2">
            <i data-lucide="alert-triangle" class="h-5 w-5 text-muted-foreground"></i>
            <h3 class="text-lg font-semibold">Alerts</h3>
        </div>
        <span id="alertCount" class="px-2 py-1 bg-primary text-primary-foreground rounded-full text-xs font-medium">Loading...</span>
    </div>
    <div class="p-6">
        <div id="alertsContainer">
            <div class="flex flex-col items-center justify-center py-12">
                <div class="animate-spin mb-4">
                    <i data-lucide="loader" class="h-8 w-8 text-muted-foreground"></i>
                </div>
                <p class="text-muted-foreground">Loading alerts...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function refreshData() {
        loadAlerts();
        loadAlertSummary();
    }
    
    function applyFilters() {
        loadAlerts();
    }
    
    function loadAlertSummary() {
        fetch('/admin/api/alerts')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.summary) {
                    displayAlertSummary(data.summary);
                }
            })
            .catch(error => console.error('Error loading alert summary:', error));
    }
    
    function displayAlertSummary(summary) {
        const html = `
            <div class="bg-card rounded-lg border border-border p-6 text-center">
                <div class="flex justify-center mb-4">
                    <div class="p-3 bg-red-100 rounded-full">
                        <i data-lucide="alert-circle" class="h-8 w-8 text-red-600"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-red-600 mb-1">${summary.critical}</h3>
                <p class="text-sm text-muted-foreground">Critical</p>
            </div>
            <div class="bg-card rounded-lg border border-border p-6 text-center">
                <div class="flex justify-center mb-4">
                    <div class="p-3 bg-yellow-100 rounded-full">
                        <i data-lucide="alert-triangle" class="h-8 w-8 text-yellow-600"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-yellow-600 mb-1">${summary.warning}</h3>
                <p class="text-sm text-muted-foreground">Warning</p>
            </div>
            <div class="bg-card rounded-lg border border-border p-6 text-center">
                <div class="flex justify-center mb-4">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i data-lucide="info" class="h-8 w-8 text-blue-600"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-blue-600 mb-1">${summary.info || 0}</h3>
                <p class="text-sm text-muted-foreground">Info</p>
            </div>
            <div class="bg-card rounded-lg border border-border p-6 text-center">
                <div class="flex justify-center mb-4">
                    <div class="p-3 bg-gray-100 rounded-full">
                        <i data-lucide="bell" class="h-8 w-8 text-gray-600"></i>
                    </div>
                </div>
                <h3 class="text-2xl font-bold text-gray-600 mb-1">${summary.total_active}</h3>
                <p class="text-sm text-muted-foreground">Total Active</p>
            </div>
        `;
        document.getElementById('alertSummary').innerHTML = html;
        lucide.createIcons();
    }
    
    function loadAlerts() {
        const resolved = document.getElementById('resolvedFilter').value;
        
        let url = '/admin/api/alerts?';
        const params = new URLSearchParams();
        
        if (resolved !== '') params.append('resolved', resolved);
        
        url += params.toString();
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAlerts(data.alerts);
                    document.getElementById('alertCount').textContent = data.alerts.length;
                } else {
                    document.getElementById('alertsContainer').innerHTML = 
                        '<div class="p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading alerts: ' + data.error + '</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('alertsContainer').innerHTML = 
                    '<div class="p-4 border border-red-200 bg-red-50 text-red-800 rounded-lg">Error loading alerts</div>';
            });
    }
    
    function displayAlerts(alerts) {
        if (alerts.length === 0) {
            document.getElementById('alertsContainer').innerHTML = 
                '<div class="flex flex-col items-center justify-center py-12"><i data-lucide="check-circle" class="h-16 w-16 text-green-600 mb-4"></i><p class="text-green-600 font-medium">No alerts found</p></div>';
            lucide.createIcons();
            return;
        }
        
        let html = '<div class="space-y-4">';
        
        alerts.forEach(alert => {
            let typeClass, typeBg, iconName;
            
            switch(alert.type) {
                case 'critical':
                    typeClass = 'text-red-800';
                    typeBg = 'bg-red-100';
                    iconName = 'alert-circle';
                    break;
                case 'warning':
                    typeClass = 'text-yellow-800';
                    typeBg = 'bg-yellow-100';
                    iconName = 'alert-triangle';
                    break;
                case 'info':
                    typeClass = 'text-blue-800';
                    typeBg = 'bg-blue-100';
                    iconName = 'info';
                    break;
                default:
                    typeClass = 'text-gray-800';
                    typeBg = 'bg-gray-100';
                    iconName = 'bell';
            }
            
            html += `
                <div class="p-4 border border-border rounded-lg bg-card hover:bg-muted/50 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-3 flex-1">
                            <div class="p-2 ${typeBg} rounded-full">
                                <i data-lucide="${iconName}" class="h-4 w-4 ${typeClass}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-2">
                                    <h4 class="font-medium text-card-foreground">${alert.title}</h4>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeBg} ${typeClass}">
                                        ${alert.type.toUpperCase()}
                                    </span>
                                    ${alert.resolved ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">RESOLVED</span>' : ''}
                                </div>
                                <p class="text-sm text-muted-foreground mb-2">${alert.message}</p>
                                <div class="text-xs text-muted-foreground space-x-4">
                                    <span>Component: ${alert.component || 'Unknown'}</span>
                                    <span>Created: ${alert.created_at}</span>
                                    ${alert.resolved_at ? `<span>Resolved: ${alert.resolved_at}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="ml-4">
                            ${!alert.resolved ? `
                                <button onclick="resolveAlert(${alert.id})" class="inline-flex items-center px-3 py-1 text-sm font-medium rounded-md bg-green-100 text-green-800 hover:bg-green-200 transition-colors">
                                    <i data-lucide="check" class="mr-1 h-3 w-3"></i>
                                    Resolve
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('alertsContainer').innerHTML = html;
        lucide.createIcons();
    }
    
    function resolveAlert(alertId) {
        if (!confirm('Are you sure you want to resolve this alert?')) {
            return;
        }
        
        fetch(`/admin/api/alerts/${alertId}/resolve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh the alerts list
                loadAlerts();
                loadAlertSummary();
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    Alert resolved successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.container-fluid').firstChild);
            } else {
                alert('Error resolving alert: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error resolving alert');
        });
    }
    
    // Load data on page load
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        loadAlerts();
        loadAlertSummary();
    });
    
    // Make refreshData available globally
    window.refreshData = refreshData;
</script>
{% endblock %}