<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VectorCraft 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .upload-area {
            transition: all 0.2s ease;
        }
        .upload-area:hover {
            border-color: #6366f1;
            background-color: #f8fafc;
        }
        
        #svgDisplay svg {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
            display: block !important;
            margin: auto !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">VectorCraft 2.0</h1>
                    <p class="text-gray-600">Professional raster to vector conversion with advanced algorithms</p>
                </div>
                <div class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                    ✓ Hybrid Engine Active
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Upload Area -->
        <div class="bg-white border border-gray-200 rounded-xl p-12 mb-8 text-center" id="uploadSection">
            <div class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-16 cursor-pointer transition-colors" 
                 id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="w-20 h-20 mx-auto mb-6 text-gray-400">
                    <i data-lucide="upload-cloud" class="w-20 h-20"></i>
                </div>
                <h2 class="text-2xl font-semibold text-gray-900 mb-3">Upload your image</h2>
                <p class="text-gray-600 mb-4">Drag and drop or click to select an image file</p>
                <p class="text-sm text-gray-500">PNG, JPG, GIF, BMP, TIFF • Max 16MB</p>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
            </div>
        </div>

        <!-- Processing State -->
        <div class="bg-white border border-gray-200 rounded-xl p-16 text-center" id="processingPanel" style="display: none;">
            <div class="w-16 h-16 mx-auto mb-6 animate-spin text-indigo-600">
                <i data-lucide="loader-2" class="w-16 h-16"></i>
            </div>
            <h2 class="text-2xl font-semibold text-gray-900 mb-3">Processing image</h2>
            <p class="text-gray-600">Converting your image to vector format...</p>
            <div class="mt-8 w-80 bg-gray-200 rounded-full h-3 mx-auto">
                <div class="bg-indigo-600 h-3 rounded-full animate-pulse" style="width: 60%"></div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" class="bg-white border border-gray-200 rounded-xl overflow-hidden" style="display: none;">
            <!-- Header Bar -->
            <div class="bg-gray-50 border-b border-gray-200 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-8">
                        <h2 class="text-2xl font-semibold text-gray-900">Vector Result</h2>
                        <div class="flex items-center gap-6 text-gray-600">
                            <span class="flex items-center gap-2">
                                <i data-lucide="clock" class="w-5 h-5"></i>
                                <span id="quickProcessingTime" class="font-medium">0.15s</span>
                            </span>
                            <span class="flex items-center gap-2">
                                <i data-lucide="layers" class="w-5 h-5"></i>
                                <span id="quickElements" class="font-medium">30 elements</span>
                            </span>
                            <span class="flex items-center gap-2">
                                <i data-lucide="star" class="w-5 h-5"></i>
                                <span id="quickQuality" class="font-medium">0.90 quality</span>
                            </span>
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium" id="qualityBadge">Excellent</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="showOriginalToggle" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-gray-700">Show Original</span>
                        </label>
                        
                        <button id="controlsToggle" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            <i data-lucide="sliders" class="w-4 h-4"></i>
                            <span>Controls</span>
                        </button>
                        
                        <button onclick="uploadNewImage()" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                            <i data-lucide="upload" class="w-4 h-4 mr-1"></i>
                            New
                        </button>
                        
                        <button onclick="downloadSVG()" 
                                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-lg hover:bg-indigo-700">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Download SVG
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex">
                <!-- Main Display Area -->
                <div class="flex-1 relative bg-white" style="height: 80vh;">
                    <img id="originalImage" class="absolute inset-0 w-full h-full object-contain p-12 opacity-0 transition-opacity duration-300">
                    <div id="svgDisplay" class="absolute inset-0 w-full h-full flex items-center justify-center p-12 transition-opacity duration-300 overflow-hidden"></div>
                    <div id="loadingOverlay" 
                         class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center" 
                         style="display: none;">
                        <div class="text-center">
                            <div class="w-12 h-12 mx-auto mb-4 animate-spin text-indigo-600">
                                <i data-lucide="loader-2" class="w-12 h-12"></i>
                            </div>
                            <p class="text-lg text-gray-600">Processing...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Controls Sidebar -->
                <div id="controlsSidebar" class="w-96 bg-gray-50 border-l border-gray-200 p-8 overflow-y-auto" style="height: 80vh; display: none;">
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-6">Adjust Parameters</h3>
                        </div>
                        
                        <!-- Quality Control -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-4">Quality</label>
                            <input type="range" id="filterSpeckle" min="1" max="10" value="4" class="w-full slider" oninput="updateParameterValue('filterSpeckle', this.value); updatePreview();">
                            <div class="flex justify-between text-sm text-gray-500 mt-2">
                                <span>Fast</span>
                                <span id="filterSpeckleValue" class="font-medium text-indigo-600">4</span>
                                <span>Best</span>
                            </div>
                        </div>
                        
                        <!-- Detail Level -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-4">Detail Level</label>
                            <input type="range" id="colorPrecision" min="1" max="16" value="8" class="w-full slider" oninput="updateParameterValue('colorPrecision', this.value); updatePreview();">
                            <div class="flex justify-between text-sm text-gray-500 mt-2">
                                <span>Simple</span>
                                <span id="colorPrecisionValue" class="font-medium text-indigo-600">8</span>
                                <span>Detailed</span>
                            </div>
                        </div>
                        
                        <!-- Smoothness -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-4">Smoothness</label>
                            <input type="range" id="cornerThreshold" min="0" max="180" value="90" class="w-full slider" oninput="updateParameterValue('cornerThreshold', this.value); updatePreview();">
                            <div class="flex justify-between text-sm text-gray-500 mt-2">
                                <span>Sharp</span>
                                <span id="cornerThresholdValue" class="font-medium text-indigo-600">90</span>
                                <span>Smooth</span>
                            </div>
                        </div>
                        
                        <!-- Advanced Settings -->
                        <details class="border-t border-gray-300 pt-6">
                            <summary class="text-sm font-medium text-gray-700 cursor-pointer mb-4">Advanced Settings</summary>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">Layer Difference</label>
                                    <input type="range" id="layerDifference" min="1" max="50" value="8" class="w-full slider" oninput="updateParameterValue('layerDifference', this.value); updatePreview();">
                                    <div class="flex justify-between text-sm text-gray-500 mt-2">
                                        <span>1</span>
                                        <span id="layerDifferenceValue" class="font-medium text-indigo-600">8</span>
                                        <span>50</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">Length Threshold</label>
                                    <input type="range" id="lengthThreshold" min="0.5" max="20" value="1.0" step="0.1" class="w-full slider" oninput="updateParameterValue('lengthThreshold', this.value); updatePreview();">
                                    <div class="flex justify-between text-sm text-gray-500 mt-2">
                                        <span>0.5</span>
                                        <span id="lengthThresholdValue" class="font-medium text-indigo-600">1.0</span>
                                        <span>20</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">Splice Threshold</label>
                                    <input type="range" id="spliceThreshold" min="0" max="100" value="20" class="w-full slider" oninput="updateParameterValue('spliceThreshold', this.value); updatePreview();">
                                    <div class="flex justify-between text-sm text-gray-500 mt-2">
                                        <span>0</span>
                                        <span id="spliceThresholdValue" class="font-medium text-indigo-600">20</span>
                                        <span>100</span>
                                    </div>
                                </div>
                            </div>
                        </details>
                        
                        <!-- Quick Actions -->
                        <div class="border-t border-gray-300 pt-6">
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="resetParameters()" class="px-4 py-3 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                                    Reset
                                </button>
                                <button onclick="setOptimalParameters()" class="px-4 py-3 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 font-medium">
                                    Optimal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form fields -->
    <input type="hidden" id="vectorizerType" value="optimized">
    <input type="hidden" id="strategy" value="vtracer_high_fidelity">
    <input type="hidden" id="targetTime" value="60">

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State management
        let currentImageFile = null;
        let currentDownloadUrl = null;

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-indigo-400', 'bg-indigo-50');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-indigo-400', 'bg-indigo-50');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-indigo-400', 'bg-indigo-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect({ target: { files: files } });
            }
        });

        // Controls toggle
        document.getElementById('controlsToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('controlsSidebar');
            if (sidebar.style.display === 'none') {
                sidebar.style.display = 'block';
                this.innerHTML = '<i data-lucide="x" class="w-5 h-5"></i><span>Close</span>';
            } else {
                sidebar.style.display = 'none';
                this.innerHTML = '<i data-lucide="sliders" class="w-5 h-5"></i><span>Controls</span>';
            }
            lucide.createIcons();
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentImageFile = file;
                processImage(file);
            }
        }

        function processImage(file) {
            showProcessing();
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('vectorizer', document.getElementById('vectorizerType').value);
            formData.append('target_time', document.getElementById('targetTime').value);
            formData.append('strategy', document.getElementById('strategy').value);
            
            // Add VTracer parameters
            addVTracerParams(formData);

            fetch('/api/vectorize', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data, file);
                } else {
                    showError(data.error || 'Processing failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Network error: ' + error.message);
            });
        }

        function addVTracerParams(formData) {
            formData.append('filter_speckle', document.getElementById('filterSpeckle').value);
            formData.append('color_precision', document.getElementById('colorPrecision').value);
            formData.append('layer_difference', document.getElementById('layerDifference').value);
            formData.append('corner_threshold', document.getElementById('cornerThreshold').value);
            formData.append('length_threshold', document.getElementById('lengthThreshold').value);
            formData.append('splice_threshold', document.getElementById('spliceThreshold').value);
            formData.append('curve_fitting', 'spline');
        }

        function showProcessing() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingPanel').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
        }

        function displayResults(data, file) {
            // Hide processing and upload
            document.getElementById('processingPanel').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // Show results
            document.getElementById('resultsContainer').style.display = 'block';
            
            // Display original image only once (not on parameter updates)
            if (!document.getElementById('originalImage').src) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('originalImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // Display SVG result
            const svgDisplay = document.getElementById('svgDisplay');
            if (data.svg_content) {
                svgDisplay.innerHTML = data.svg_content;
                
                // Ensure SVG scales properly
                setTimeout(() => {
                    const svg = svgDisplay.querySelector('svg');
                    if (svg) {
                        svg.removeAttribute('width');
                        svg.removeAttribute('height');
                        svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                        
                        if (!svg.getAttribute('viewBox')) {
                            try {
                                const bbox = svg.getBBox();
                                if (bbox.width > 0 && bbox.height > 0) {
                                    svg.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
                                }
                            } catch (e) {
                                console.warn('Could not set viewBox:', e);
                            }
                        }
                    }
                }, 100);
            }
            
            // Store download URL
            currentDownloadUrl = data.download_url;
            
            // Update stats and quality badge
            updateQuickStats(data);
            updateQualityBadge(data.quality_score || 0.8);
            
            // Initialize before/after toggle only once
            if (!document.getElementById('showOriginalToggle').hasEventListener) {
                initializeBeforeAfterToggle();
                document.getElementById('showOriginalToggle').hasEventListener = true;
            }
        }

        function updateQuickStats(data) {
            document.getElementById('quickProcessingTime').textContent = `${data.processing_time.toFixed(2)}s`;
            document.getElementById('quickElements').textContent = `${data.num_elements} elements`;
            document.getElementById('quickQuality').textContent = `${data.quality_score.toFixed(2)} quality`;
        }
        
        function initializeBeforeAfterToggle() {
            const toggle = document.getElementById('showOriginalToggle');
            const originalImage = document.getElementById('originalImage');
            const svgDisplay = document.getElementById('svgDisplay');
            
            // Set initial state (show vector result)
            originalImage.style.opacity = '0';
            svgDisplay.style.opacity = '1';
            toggle.checked = false;
            
            toggle.addEventListener('change', function() {
                if (this.checked) {
                    originalImage.style.opacity = '1';
                    svgDisplay.style.opacity = '0';
                } else {
                    originalImage.style.opacity = '0';
                    svgDisplay.style.opacity = '1';
                }
            });
        }

        function updateQualityBadge(score) {
            const badge = document.getElementById('qualityBadge');
            if (score >= 0.9) {
                badge.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium';
                badge.textContent = 'Excellent';
            } else if (score >= 0.8) {
                badge.className = 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium';
                badge.textContent = 'High Quality';
            } else if (score >= 0.7) {
                badge.className = 'px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium';
                badge.textContent = 'Good';
            } else {
                badge.className = 'px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium';
                badge.textContent = 'Needs Tuning';
            }
        }

        function downloadSVG() {
            if (currentDownloadUrl) {
                window.open(currentDownloadUrl, '_blank');
            }
        }

        function showError(message) {
            document.getElementById('processingPanel').style.display = 'none';
            alert('Error: ' + message);
            document.getElementById('uploadSection').style.display = 'block';
        }

        function resetParameters() {
            document.getElementById('filterSpeckle').value = 4;
            document.getElementById('colorPrecision').value = 8;
            document.getElementById('cornerThreshold').value = 90;
            document.getElementById('layerDifference').value = 8;
            document.getElementById('lengthThreshold').value = 1.0;
            document.getElementById('spliceThreshold').value = 20;
        }

        function setOptimalParameters() {
            document.getElementById('filterSpeckle').value = 6;
            document.getElementById('colorPrecision').value = 10;
            document.getElementById('cornerThreshold').value = 60;
            document.getElementById('layerDifference').value = 12;
            document.getElementById('lengthThreshold').value = 0.8;
            document.getElementById('spliceThreshold').value = 15;
            
            // Update display values
            document.getElementById('filterSpeckleValue').textContent = 6;
            document.getElementById('colorPrecisionValue').textContent = 10;
            document.getElementById('cornerThresholdValue').textContent = 60;
            document.getElementById('layerDifferenceValue').textContent = 12;
            document.getElementById('lengthThresholdValue').textContent = 0.8;
            document.getElementById('spliceThresholdValue').textContent = 15;
            
            // Trigger update if image is loaded
            if (currentImageFile) {
                updatePreview();
            }
        }

        function uploadNewImage() {
            // Reset to upload state
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('processingPanel').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            
            // Reset file input
            document.getElementById('fileInput').value = '';
            currentImageFile = null;
            currentDownloadUrl = null;
        }

        function updateParameterValue(paramName, value) {
            // Update the display value
            document.getElementById(paramName + 'Value').textContent = value;
        }

        let updateTimeout = null;
        let isProcessing = false;
        
        function updatePreview() {
            if (!currentImageFile || isProcessing) return;
            
            // Show loading overlay only if results are visible
            if (document.getElementById('resultsContainer').style.display === 'block') {
                document.getElementById('loadingOverlay').style.display = 'flex';
            }
            
            // Debounce updates to avoid too many requests
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                if (!isProcessing) {
                    isProcessing = true;
                    processImageUpdate(currentImageFile);
                }
            }, 800);
        }

        function processImageUpdate(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('vectorizer', document.getElementById('vectorizerType').value);
            formData.append('target_time', document.getElementById('targetTime').value);
            formData.append('strategy', document.getElementById('strategy').value);
            
            // Add VTracer parameters
            addVTracerParams(formData);

            fetch('/api/vectorize', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                isProcessing = false;
                if (data.success) {
                    displayResults(data, file);
                } else {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    console.error('Update failed:', data.error);
                }
            })
            .catch(error => {
                isProcessing = false;
                document.getElementById('loadingOverlay').style.display = 'none';
                console.error('Update error:', error);
            });
        }
    </script>
</body>
</html>